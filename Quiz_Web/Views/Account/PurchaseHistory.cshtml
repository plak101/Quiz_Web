@model Quiz_Web.Models.Entities.User
@{
    ViewData["Title"] = "Lịch sử mua hàng";
    Layout = "_Layout";
}

<link rel="stylesheet" href="~/css/account-settings.css" asp-append-version="true" />

<div class="account-settings-container">
    <div class="account-settings-content">
        <h1 class="page-title">Tài khoản</h1>
        
        <!-- Tabs Navigation -->
        <div class="tabs-navigation">
            <a href="@Url.Action("Settings", "Account")" class="tab-link">Cài đặt tài khoản</a>
            <a href="@Url.Action("Profile", "Account")" class="tab-link">Chỉnh sửa hồ sơ</a>
            <a href="@Url.Action("PurchaseHistory", "Account")" class="tab-link active">Lịch sử mua hàng</a>
        </div>

        <!-- Purchase History Content -->
        @* <div class="settings-section"> *@
            <div class="">
            <!-- Test Button for Development -->
            <div class="mb-3">
                @* <button id="updatePendingBtn" class="btn btn-warning" onclick="updatePendingPurchases()">
                    <i class="bi bi-arrow-clockwise"></i> Cập nhật giao dịch pending (Test)
                </button> *@
                <small class="text-muted ms-2">Số lượng purchase: @ViewBag.PurchaseCount</small>
            </div>
            
            <div class="purchase-list">
                @if (ViewBag.Purchases != null && ((List<Quiz_Web.Models.Entities.CoursePurchase>)ViewBag.Purchases).Any())
                {
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Khóa học</th>
                                    <th>Giá</th>
                                    <th>Ngày mua</th>
                                    <th>Trạng thái</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var purchase in (List<Quiz_Web.Models.Entities.CoursePurchase>)ViewBag.Purchases)
                                {
                                    <tr>
                                        <td>
                                            <strong>@purchase.Course.Title</strong>
                                            <br>
                                            <small class="text-muted">@purchase.Course.Summary</small>
                                        </td>
                                        <td>
                                            <span class="fw-bold">@purchase.PricePaid.ToString("N0") VNĐ</span>
                                        </td>
                                        <td>
                                            @purchase.PurchasedAt.ToString("dd/MM/yyyy HH:mm")
                                        </td>
                                        <td>
                                            <span class="badge bg-success purchase-status" data-status="@purchase.Status">
                                                @(purchase.Status == "Paid" ? "Đã thanh toán" : purchase.Status)
                                            </span>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <p class="text-muted text-center py-5">
                        <i class="bi bi-cart-x" style="font-size: 48px; display: block; margin-bottom: 16px;"></i>
                        Bạn chưa có đơn hàng nào
                    </p>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        function updatePendingPurchases() {
            const btn = document.getElementById('updatePendingBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Đang xử lý...';
            
            fetch('/Payment/UpdatePendingPurchases', {
                method: 'POST',
                headers: {
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Thành công!',
                        text: data.message,
                        confirmButtonText: 'OK'
                    }).then(() => {
                        location.reload();
                    });
                } else {
                    Swal.fire({
                        icon: 'info',
                        title: 'Thông báo',
                        text: data.message,
                        confirmButtonText: 'OK'
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi!',
                    text: 'Có lỗi xảy ra khi cập nhật',
                    confirmButtonText: 'OK'
                });
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Cập nhật giao dịch pending (Test)';
            });
        }
    </script>
}
