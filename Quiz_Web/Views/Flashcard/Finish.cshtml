@{
    ViewData["Title"] = "Hoàn thành!";
    Layout = "~/Views/Shared/_LayoutFlashcards.cshtml";
    
    // Get course info from query string if coming from course
    var courseSlug = Context.Request.Query["courseSlug"].ToString();
    var lessonId = Context.Request.Query["lessonId"].ToString();
    var contentId = Context.Request.Query["contentId"].ToString();
    var hasCourseLinkData = !string.IsNullOrEmpty(courseSlug) && 
                             !string.IsNullOrEmpty(lessonId) && 
                             !string.IsNullOrEmpty(contentId);
}

@section Styles {
    <link rel="stylesheet" href="~/css/flashcards/common.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/flashcards/finish.css" asp-append-version="true" />
}

<div class="flashcard-container finish-container">
    <div class="finish-content text-center">
        <div class="finish-icon display-1 mb-4">🎉</div>
        <h1 class="finish-title display-3 fw-bold text-white mb-3">Làm Tốt Lắm!</h1>
        <p class="finish-message fs-5 text-white mb-5 lh-lg">
            Bạn đã hoàn thành tất cả các flashcards trong bộ này.<br>
            Hãy tiếp tục học tập để nâng cao kiến thức của bạn!
        </p>
        
        <div class="finish-actions d-flex flex-column gap-3 mx-auto" style="max-width: 400px;">
            <a href="/flashcards/study/@ViewBag.SetId@(hasCourseLinkData ? $"?courseSlug={courseSlug}&lessonId={lessonId}&contentId={contentId}" : "")" 
               class="btn btn-warning btn-lg rounded-pill shadow d-flex align-items-center justify-content-center gap-2">
                <i class="bi bi-arrow-clockwise"></i>
                <span>Bắt đầu lại</span>
            </a>
            
            @if (hasCourseLinkData)
            {
                <a href="/course/learn/@courseSlug?lessonId=@lessonId" 
                   class="btn btn-success btn-lg rounded-pill shadow d-flex align-items-center justify-content-center gap-2"
                   id="returnToCourseBtn">
                    <i class="bi bi-arrow-left-circle"></i>
                    <span>Quay về khóa học</span>
                </a>
            }
            else
            {
                <a href="/flashcards" 
                   class="btn btn-success btn-lg rounded-pill shadow d-flex align-items-center justify-content-center gap-2">
                    <i class="bi bi-book"></i>
                    <span>Xem thêm các flashcard khác</span>
                </a>
            }
            
            <a href="@Url.Action("Index", "Home")" 
               class="btn btn-primary btn-lg rounded-pill shadow d-flex align-items-center justify-content-center gap-2">
                <i class="bi bi-house-door"></i>
                <span>Trang chủ</span>
            </a>
        </div>
    </div>
    
    <!-- Decorative confetti effect -->
    <div class="confetti-container" id="confettiContainer"></div>
    
    <!-- Hidden data for tracking -->
    @if (hasCourseLinkData)
    {
        <input type="hidden" id="courseSlug" value="@courseSlug" />
        <input type="hidden" id="lessonId" value="@lessonId" />
        <input type="hidden" id="contentId" value="@contentId" />
    }
</div>

@section Scripts {
    <script src="~/js/flashcards/finish.js" asp-append-version="true"></script>
    
    @if (hasCourseLinkData)
    {
        <script>
            // Mark flashcard content as completed when page loads
            document.addEventListener('DOMContentLoaded', function() {
                markFlashcardComplete();
            });
            
            async function markFlashcardComplete() {
                const courseSlug = document.getElementById('courseSlug')?.value;
                const lessonId = document.getElementById('lessonId')?.value;
                const contentId = document.getElementById('contentId')?.value;
                
                if (!courseSlug || !lessonId || !contentId) return;
                
                try {
                    const response = await fetch('/api/course-progress/mark-content-complete', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            courseSlug: courseSlug,
                            lessonId: parseInt(lessonId),
                            contentId: parseInt(contentId),
                            contentType: 'FlashcardSet'
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        console.log('Flashcard content marked as completed');
                        // ✅ Set flag để course page reload progress
                        localStorage.setItem('courseProgressUpdated', Date.now().toString());
                    } else {
                        console.warn('Failed to mark completion:', data.message);
                    }
                } catch (error) {
                    console.error('Error marking flashcard complete:', error);
                }
            }
            
            // ✅ Also set flag when user clicks "Quay về khóa học"
            document.getElementById('returnToCourseBtn')?.addEventListener('click', function() {
                localStorage.setItem('courseProgressUpdated', Date.now().toString());
            });
        </script>
    }
}
