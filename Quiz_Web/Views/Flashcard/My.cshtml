@model List<Quiz_Web.Models.Entities.FlashcardSet>
@{
    ViewData["Title"] = "Bộ Flashcard của tôi";
}

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="mb-0">Bộ Flashcard của tôi</h2>
        <a asp-action="Create" class="btn btn-info text-white">
            <i class="fa-solid fa-plus me-1"></i> Tạo bộ Flashcard
        </a>
    </div>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show">
            @TempData["Success"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show">
            @TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (Model == null || !Model.Any())
    {
        <div class="alert alert-info">
            <i class="fa-solid fa-info-circle me-2"></i>Bạn chưa tạo bộ flashcard nào.
        </div>
    }
    else
    {
        <div class="table-responsive">
            <table class="table align-middle" id="flashcardsTable">
                <thead>
                <tr>
                    <th style="width:60px">ID</th>
                    <th>Tiêu đề</th>
                    <th>Số thẻ</th>
                    <th>Hiển thị</th>
                    <th>Ngôn ngữ</th>
                    <th>Tạo lúc</th>
                    <th class="text-end w-100">Hành động</th>
                </tr>
                </thead>
                <tbody>
                @foreach (var set in Model)
                {
                    <tr>
                        <td class="text-start">@set.SetId</td>
                        <td>
                            <div class="fw-semibold">@set.Title</div>
                            @if (!string.IsNullOrWhiteSpace(set.TagsText))
                            {
                                <div class="text-muted small">
                                    @foreach (var tag in set.TagsText.Split(',').Take(3))
                                    {
                                        <span class="badge bg-light text-dark me-1">@tag.Trim()</span>
                                    }
                                </div>
                            }
                        </td>
                        <td>
                            <span class="badge bg-info">
                                @(set.Flashcards?.Count ?? 0) thẻ
                            </span>
                        </td>
                        <td>
                            <span class="badge @(set.Visibility == "Public" ? "bg-success" : "bg-secondary")">
                                @(set.Visibility == "Public" ? "Công khai" : set.Visibility == "Private" ? "Riêng tư" : set.Visibility)
                            </span>
                        </td>
                        <td>@(set.Language ?? "N/A")</td>
                        <td>@set.CreatedAt.ToString("dd/MM/yyyy")</td>
                        <td class="text-end"><!-- filled by DataTables render --></td>
                    </tr>
                }
                </tbody>
            </table>
        </div>
    }
</div>

<!-- Hidden delete form for POST + AntiForgery -->
<form id="deleteForm" method="post" style="display:none;">
    @Html.AntiForgeryToken()
</form>

@section Styles {
    <link rel="stylesheet" href="https://cdn.datatables.net/2.1.5/css/dataTables.bootstrap5.min.css" />
}

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/2.1.5/js/dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/2.1.5/js/dataTables.bootstrap5.min.js"></script>
    <script>
        function submitDelete(id) {
            if (!confirm('Bạn chắc muốn xóa bộ flashcard này?')) return;
            const f = document.getElementById('deleteForm');
            f.action = `/flashcards/delete/${id}`;
            f.submit();
        }

        $(function () {
            $('#flashcardsTable').DataTable({
                order: [[5, 'desc']], // sort by "Tạo lúc"
                columnDefs: [
                    {
                        targets: -1,
                        orderable: false,
                        searchable: false,
                        className: 'text-end',
                        render: function (data, type, row) {
                            const id = row[0];
                            const viewUrl = `/flashcards/${id}`;
                            const editUrl = `/flashcards/edit/${id}`;
                            const studyUrl = `/flashcards/study/${id}`;

                            return `
                                <a href="${viewUrl}" class="btn btn-sm btn-info text-white btn-action">
                                    <i class="fa-solid fa-eye me-1"></i>Xem
                                </a>
                                <a href="${studyUrl}" class="btn btn-sm btn-primary text-white btn-action">
                                    <i class="fa-solid fa-play me-1"></i>Học
                                </a>
                                <a href="${editUrl}" class="btn btn-sm btn-warning text-dark btn-action">
                                    <i class="fa-solid fa-pen-to-square me-1"></i>Sửa
                                </a>
                                <button type="button" class="btn btn-sm btn-danger btn-action" onclick="submitDelete(${id})">
                                    <i class="fa-solid fa-trash-can me-1"></i>Xóa
                                </button>`;
                        }
                    }
                ],
                language: { url: 'https://cdn.datatables.net/plug-ins/2.1.5/i18n/vi.json' }
            });
        });
    </script>
}
