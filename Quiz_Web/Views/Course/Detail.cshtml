@using System.Security.Claims
@model Quiz_Web.Models.Entities.Course
@{
	ViewData["Title"] = Model.Title;
	var isOwner = (ViewBag.IsOwner as bool?) ?? false;

	// Tính toán thống kê
	var totalChapters = Model.CourseChapters?.Count ?? 0;
	var totalLessons = Model.CourseChapters?.Sum(c => c.Lessons?.Count ?? 0) ?? 0;
	var totalStudents = Model.CoursePurchases?.Count ?? 0;

	// Check if user can review (passed from controller)
	var userIdClaim = User.FindFirstValue(ClaimTypes.NameIdentifier);
	var userId = !string.IsNullOrEmpty(userIdClaim) && int.TryParse(userIdClaim, out var uid) ? uid : 0;
	var userReview = userId > 0 ? Model.CourseReviews?.FirstOrDefault(r => r.UserId == userId) : null;
	var hasPurchased = userId > 0 && Model.CoursePurchases?.Any(p => p.BuyerId == userId && p.Status == "Paid") == true;
	var canReview = hasPurchased && userReview == null && !isOwner;
}

@section Styles {
	<link rel="stylesheet" href="~/css/course/course-detail.css" asp-append-version="true" />
}

<!-- Hero Section -->
<section class="course-hero">
	<div class="container">
		<div class="row">
			<div class="col-lg-8">
				<!-- Breadcrumb -->
				<nav aria-label="breadcrumb" class="mb-3">
					<ol class="breadcrumb">
						<li class="breadcrumb-item"><a asp-controller="Course" asp-action="Index">Khóa học</a></li>
						@if (Model.Category != null)
						{
							<li class="breadcrumb-item"><a asp-controller="Course" asp-action="Category" asp-route-category="@Model.Category.Slug">@Model.Category.Name</a></li>
						}
						<li class="breadcrumb-item active" aria-current="page">@Model.Title</li>
					</ol>
				</nav>

				<!-- Course Title -->
				<h1 class="course-title">@Model.Title</h1>

				<!-- Course Meta Info -->
				<div class="course-meta">
					@if (Model.AverageRating >= 4.5m)
					{
						<div class="meta-item">
							<span class="badge bg-warning text-dark">Bestseller</span>
						</div>
					}
					<div class="meta-item">
						<span class="rating-value">@Model.AverageRating.ToString("F1")</span>
						<div class="stars">
							@for (int i = 1; i <= 5; i++)
							{
								if (i <= Model.AverageRating)
								{
									<i class="fas fa-star"></i>
								}
								else if (i - 0.5m <= Model.AverageRating)
								{
									<i class="fas fa-star-half-stroke"></i>
								}
								else
								{
									<i class="far fa-star"></i>
								}
							}
						</div>
						<span class="rating-count">(@Model.TotalReviews.ToString("N0") đánh giá)</span>
					</div>
					<div class="meta-item">
						<i class="fas fa-user-graduate"></i>
						<span>@totalStudents.ToString("N0") học viên</span>
					</div>
				</div>

				<!-- Instructor Info -->
				<div class="instructor-info">
					<span>Được tạo bởi</span>
					<a href="#instructor-section" class="instructor-name">@Model.Owner.FullName</a>
				</div>

				<!-- Last Updated -->
				<div class="last-updated">
					<i class="far fa-clock"></i>
					<span>Cập nhật lần cuối @(Model.UpdatedAt?.ToString("MM/yyyy") ?? Model.CreatedAt.ToString("MM/yyyy"))</span>
				</div>
			</div>

		</div>
	</div>
</section>

<!-- Main Content -->
<section class="course-content-section">
	<div class="container">
		<div class="row">
			<div class="col-lg-8">
				<!-- Course Content -->
				<div class="content-box">
					<div class="d-flex justify-content-between align-items-center mb-3">
						<h2>Nội dung khóa học</h2>
						<button class="btn btn-link" id="expandAllBtn">Mở rộng tất cả</button>
					</div>

					<div class="course-stats mb-3">
						<span>@totalChapters chương</span>
						<span class="mx-2">•</span>
						<span>@totalLessons bài học</span>
					</div>

					<div class="accordion" id="courseContentAccordion">
						@if (Model.CourseChapters != null && Model.CourseChapters.Any())
						{
							var chapterIndex = 0;
							foreach (var chapter in Model.CourseChapters.OrderBy(c => c.OrderIndex))
							{
								var chapterId = $"chapter{chapterIndex}";
								var lessonCount = chapter.Lessons?.Count ?? 0;

								<div class="accordion-item">
									<h3 class="accordion-header">
										<button class="accordion-button @(chapterIndex > 0 ? "collapsed" : "")"
												type="button"
												data-bs-toggle="collapse"
												data-bs-target="#@chapterId"
												aria-expanded="@(chapterIndex == 0 ? "true" : "false")">
											<div class="chapter-header-content">
												<div>
													<strong>@chapter.Title</strong>
													@if (!string.IsNullOrEmpty(chapter.Description))
													{
														<div class="text-muted mb-0 small">@Html.Raw(chapter.Description)</div>
													}
												</div>
												<span class="badge bg-secondary">@lessonCount bài học</span>
											</div>
										</button>
									</h3>
									<div id="@chapterId"
										 class="accordion-collapse collapse @(chapterIndex == 0 ? "show" : "")"
										 data-bs-parent="#courseContentAccordion">
										<div class="accordion-body">
											@if (chapter.Lessons != null && chapter.Lessons.Any())
											{
												<ul class="lesson-list">
													@foreach (var lesson in chapter.Lessons.OrderBy(l => l.OrderIndex))
													{
														var isPreview = lesson.Visibility == "Public";
														var contentTypes = lesson.LessonContents?.Select(c => c.ContentType).ToList() ?? new List<string>();
														var hasVideo = contentTypes.Contains("Video");
														var hasTheory = contentTypes.Contains("Theory");
														var hasFlashcard = contentTypes.Contains("FlashcardSet");
														var hasTest = contentTypes.Contains("Test");

														string iconClass = "fa-file-alt";
														if (hasVideo) iconClass = "fa-play-circle";
														else if (hasTest) iconClass = "fa-clipboard-check";
														else if (hasFlashcard) iconClass = "fa-layer-group";

														<li class="lesson-item">
															<div class="lesson-info">
																<i class="fas @iconClass"></i>
																<span class="lesson-title">@lesson.Title</span>

																<div class="content-type-badges ms-2">
																	@if (hasVideo)
																	{
																		<span class="badge bg-primary" title="Video">
																			<i class="fas fa-video"></i>
																		</span>
																	}
																	@if (hasTheory)
																	{
																		<span class="badge bg-info" title="Lý thuyết">
																			<i class="fas fa-book"></i>
																		</span>
																	}
																	@if (hasFlashcard)
																	{
																		<span class="badge bg-warning" title="Flashcard">
																			<i class="fas fa-layer-group"></i>
																		</span>
																	}
																	@if (hasTest)
																	{
																		<span class="badge bg-success" title="Bài kiểm tra">
																			<i class="fas fa-clipboard-check"></i>
																		</span>
																	}
																</div>

																@if (isPreview)
																{
																	<button class="btn btn-link btn-sm preview-btn">
																		<i class="fas fa-eye me-1"></i>Xem trước
																	</button>
																}
															</div>
															@if (!string.IsNullOrEmpty(lesson.Description))
															{
																<p class="lesson-description">@lesson.Description</p>
															}
														</li>
													}
												</ul>
											}
											else
											{
												<p class="text-muted">Chương này chưa có bài học nào.</p>
											}
										</div>
									</div>
								</div>
								chapterIndex++;
							}
						}
						else
						{
							<div class="alert alert-info">
								<i class="fas fa-info-circle me-2"></i>
								Nội dung khóa học đang được cập nhật.
							</div>
						}
					</div>
				</div>

				<!-- Description -->
				<div class="content-box">
					<h2>Mô tả</h2>
					<div class="ck-content course-description">
						@Html.Raw(Model.Summary)
					</div>
				</div>

				<!-- Instructor -->
				<div class="content-box" id="instructor-section">
					<h2>Giảng viên</h2>
					<div class="instructor-card">
						<div class="d-flex">
							<div class="instructor-avatar me-3">
								@{
									var initials = string.Join("", Model.Owner.FullName.Split(' ', StringSplitOptions.RemoveEmptyEntries).Select(w => w.FirstOrDefault())).ToUpper();
								}
								<span>@initials</span>
							</div>
							<div class="flex-grow-1">
								<h4>@Model.Owner.FullName</h4>
								<p class="text-muted">@Model.Owner.Email</p>
								<div class="instructor-stats">
									<div><i class="fas fa-star"></i> @Model.AverageRating.ToString("F1") Đánh giá</div>
									<div><i class="fas fa-user-graduate"></i> @totalStudents.ToString("N0") Học viên</div>
									<div><i class="fas fa-play-circle"></i> @totalChapters Khóa học</div>
								</div>
							</div>
						</div>
					</div>
				</div>

				<!-- Reviews -->
				<div class="content-box">
					<h2>Đánh giá của học viên</h2>

					<!-- Review Form for authenticated users who purchased the course -->
					@if (User.Identity?.IsAuthenticated == true)
					{
						if (canReview)
						{
							<div class="alert alert-info mb-4">
								<div class="d-flex justify-content-between align-items-center">
									<span><i class="fas fa-star me-2"></i>Bạn đã mua khóa học này. Hãy chia sẻ trải nghiệm của bạn!</span>
									<button class="btn btn-primary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#reviewForm">
										Viết đánh giá
									</button>
								</div>

								<div class="collapse mt-3" id="reviewForm">
									<div class="card card-body">
										<form asp-controller="Review" asp-action="Create" method="post">
											@Html.AntiForgeryToken()
											<input type="hidden" name="CourseId" value="@Model.CourseId" />

											<div class="mb-3">
												<label class="form-label fw-bold">Đánh giá của bạn <span class="text-danger">*</span></label>
												<div class="star-rating-input d-flex gap-2">
													<div class="stars-interactive" id="starRatingInput">
														<i class="fa-regular fa-star star" data-rating="1"></i>
														<i class="fa-regular fa-star star" data-rating="2"></i>
														<i class="fa-regular fa-star star" data-rating="3"></i>
														<i class="fa-regular fa-star star" data-rating="4"></i>
														<i class="fa-regular fa-star star" data-rating="5"></i>
													</div>
													<span id="ratingLabel" class="text-muted"></span>
												</div>
												<input type="hidden" name="Rating" id="ratingValue" required />
											</div>

											<div class="mb-3">
												<label class="form-label fw-bold">Nhận xét (tùy chọn)</label>
												<textarea name="Comment" class="form-control" rows="4"
												  placeholder="Chia sẻ suy nghĩ của bạn về khóa học này..."
												  maxlength="1000"></textarea>
												<div class="form-text">Tối đa 1000 ký tự</div>
											</div>

											<div class="d-flex gap-2">
												<button type="submit" class="btn btn-primary">
													<i class="fas fa-paper-plane me-2"></i>Gửi đánh giá
												</button>
												<button type="button" class="btn btn-secondary" data-bs-toggle="collapse" data-bs-target="#reviewForm">
													Hủy
												</button>
											</div>
										</form>
									</div>
								</div>
							</div>
						}
						else if (userReview != null)
						{
							<div class="alert alert-success mb-4">
								<div class="d-flex justify-content-between align-items-center">
									<div>
										<i class="fas fa-check-circle me-2"></i>
										<strong>Đánh giá của bạn:</strong>
										<div class="mt-2">
											<div class="stars-small">
												@for (int i = 1; i <= 5; i++)
												{
													if (i <= userReview.Rating)
													{
														<i class="fas fa-star"></i>
													}
													else
													{
														<i class="far fa-star"></i>
													}
												}
											</div>
											@if (!string.IsNullOrEmpty(userReview.Comment))
											{
												<p class="mb-0 mt-2">@userReview.Comment</p>
											}
										</div>
									</div>
									<div class="d-flex gap-2">
										<a asp-controller="Review" asp-action="Edit" asp-route-id="@userReview.ReviewId"
										   class="btn btn-warning btn-sm">
											<i class="fas fa-edit me-1"></i>Sửa
										</a>
										<form asp-controller="Review" asp-action="Delete" asp-route-id="@userReview.ReviewId"
											  method="post" style="display: inline;"
											  onsubmit="return confirm('Bạn có chắc muốn xóa đánh giá này?');">
											@Html.AntiForgeryToken()
											<button type="submit" class="btn btn-danger btn-sm">
												<i class="fas fa-trash me-1"></i>Xóa
											</button>
										</form>
									</div>
								</div>
							</div>
						}
						else if (!hasPurchased && !isOwner)
						{
							<div class="alert alert-warning mb-4">
								<i class="fas fa-info-circle me-2"></i>
								Bạn cần mua khóa học để có thể đánh giá.
							</div>
						}
					}
					else
					{
						<div class="alert alert-info mb-4">
							<i class="fas fa-sign-in-alt me-2"></i>
							<a asp-controller="Account" asp-action="Login" asp-route-returnUrl="@Context.Request.Path">Đăng nhập</a>
							để đánh giá khóa học này.
						</div>
					}

					<!-- Reviews Summary -->
					<div class="reviews-summary">
						<div class="row align-items-center">
							<div class="col-md-4 text-center">
								<div class="average-rating-large">
									<h1 class="display-3">@Model.AverageRating.ToString("F1")</h1>
									<div class="stars-large mb-2">
										@for (int i = 1; i <= 5; i++)
										{
											if (i <= Model.AverageRating)
											{
												<i class="fas fa-star"></i>
											}
											else if (i - 0.5m <= Model.AverageRating)
											{
												<i class="fas fa-star-half-stroke"></i>
											}
											else
											{
												<i class="far fa-star"></i>
											}
										}
									</div>
									<p class="text-muted">@Model.TotalReviews.ToString("N0") đánh giá</p>
								</div>
							</div>
							<div class="col-md-8">
								<!-- Rating bars -->
								@for (int i = 5; i >= 1; i--)
								{
									var percentage = Model.TotalReviews > 0 ? (Model.CourseReviews?.Count(r => r.Rating == i) ?? 0) * 100 / Model.TotalReviews : 0;
									<div class="rating-bar-item">
										<div class="progress flex-grow-1">
											<div class="progress-bar" style="width: @percentage%"></div>
										</div>
										<div class="stars-small">
											@for (int j = 1; j <= i; j++)
											{
												<i class="fas fa-star"></i>
											}
										</div>
										<span class="ms-2">@percentage%</span>
									</div>
								}
							</div>
						</div>
					</div>

					@if (Model.CourseReviews != null && Model.CourseReviews.Any())
					{
						<div class="reviews-list mt-4">
							@foreach (var review in Model.CourseReviews.OrderByDescending(r => r.CreatedAt).Take(5))
							{
								<div class="review-item">
									<div class="d-flex">
										<div class="reviewer-avatar me-3">
											@{
												var reviewerInitials = string.Join("", review.User.FullName.Split(' ', StringSplitOptions.RemoveEmptyEntries).Select(w => w.FirstOrDefault())).ToUpper();
											}
											<span>@reviewerInitials</span>
										</div>
										<div class="flex-grow-1">
											<h6>@review.User.FullName</h6>
											<div class="review-rating mb-2">
												@for (int i = 1; i <= 5; i++)
												{
													if (i <= review.Rating)
													{
														<i class="fas fa-star"></i>
													}
													else
													{
														<i class="far fa-star"></i>
													}
												}
												<span class="text-muted ms-2">@review.CreatedAt.ToString("dd/MM/yyyy")</span>
											</div>
											@if (!string.IsNullOrEmpty(review.Comment))
											{
												<p>@review.Comment</p>
											}
										</div>
									</div>
								</div>
							}
						</div>
					}
				</div>
			</div>

			<!-- Empty column for layout balance on desktop -->
			<!-- Sidebar Card (Desktop) - Positioned in Hero -->
			<div class="col-lg-4 d-none d-lg-block">
				<div class="floating-sidebar-wrapper">
					@if (!isOwner)
					{
						<div class="course-card-sidebar">
							@if (!string.IsNullOrEmpty(Model.CoverUrl))
							{
								<img src="@Model.CoverUrl" class="card-img-top" alt="@Model.Title" />
							}
							else
							{
								<div class="card-img-placeholder">
									<i class="fas fa-book"></i>
								</div>
							}
							<div class="card-body">
								@if (Model.Price == 0)
								{
									<h2 class="price text-success">MIỄN PHÍ</h2>
								}
								else
								{
									<div class="pricing">
										<h2 class="current-price">₫@Model.Price.ToString("N0")</h2>
									</div>
								}

								<div class="d-grid gap-2 mt-3">
									@if (hasPurchased)
									{
										<a asp-controller="Course" asp-action="Learn" asp-route-slug="@Model.Slug"
										   class="btn btn-primary btn-lg">
											<i class="fas fa-play-circle me-2"></i>Bắt đầu học
										</a>
									}
									else
									{
										<button class="btn btn-primary btn-lg" onclick="addCourseToCart(@Model.CourseId)">
											Thêm vào giỏ hàng
										</button>
										<button class="btn btn-outline-dark btn-lg" onclick="addToCartAndRedirect(@Model.CourseId)">
											<i class="far fa-heart me-2"></i>Mua khóa học
										</button>
									}
									@* <button class="btn btn-outline-dark btn-lg">
										<i class="far fa-heart me-2"></i>Yêu thích
									</button> *@
								</div>
							</div>
						</div>
					}
					else
					{
						<div class="owner-actions-card">
							<div class="card-body">
								<h5 class="mb-3">Quản lý khóa học</h5>
								<div class="d-grid gap-2">
									<a asp-controller="Course" asp-action="Builder" asp-route-id="@Model.CourseId" class="btn btn-primary">
										<i class="fas fa-edit me-2"></i>Chỉnh sửa khóa học
									</a>
									<a asp-controller="Course" asp-action="Learn" asp-route-slug="@Model.Slug"
									   class="btn btn-outline-primary">
										<i class="fas fa-play-circle me-2"></i>Xem trước bài học
									</a>
									@* <a href="#" class="btn btn-outline-secondary">
										<i class="fas fa-chart-line me-2"></i>Xem thống kê
									</a> *@
								</div>
							</div>
						</div>
					}
				</div>
			</div>
		</div>
	</div>
</section>

<!-- Mobile Sticky Bottom Bar -->
@if (!isOwner)
{
	<div class="mobile-bottom-bar d-lg-none">
		<div class="d-flex justify-content-between align-items-center">
			<div>
				@if (Model.Price == 0)
				{
					<div class="price-mobile text-success fw-bold">MIỄN PHÍ</div>
				}
				else
				{
					<div class="price-mobile">₫@Model.Price.ToString("N0")</div>
				}
			</div>
			@if (hasPurchased)
			{
				<a asp-controller="Course" asp-action="Learn" asp-route-slug="@Model.Slug"
				   class="btn btn-primary">
					<i class="fas fa-play-circle me-2"></i>Bắt đầu học
				</a>
			}
			else
			{
				<button class="btn btn-primary" onclick="addToCartAndRedirect(@Model.CourseId)">
					Thêm vào giỏ hàng
				</button>
			}
		</div>
	</div>
}

@section Scripts {
	<script src="~/js/course/course-detail.js" asp-append-version="true"></script>
	<script>
		// Expand/Collapse all accordion
		document.getElementById('expandAllBtn')?.addEventListener('click', function() {
			const accordionItems = document.querySelectorAll('.accordion-collapse');
			const isExpanded = this.textContent.includes('Thu gọn');

			accordionItems.forEach(item => {
				if (isExpanded) {
					const bsCollapse = bootstrap.Collapse.getInstance(item);
					if (bsCollapse) bsCollapse.hide();
				} else {
					new bootstrap.Collapse(item, { show: true });
				}
			});

			this.textContent = isExpanded ? 'Mở rộng tất cả' : 'Thu gọn tất cả';
		});

		// Star rating for review form
		const stars = document.querySelectorAll('#starRatingInput .star');
		const ratingValue = document.getElementById('ratingValue');
		const ratingLabel = document.getElementById('ratingLabel');

		const ratingLabels = {
			1: 'Rất tệ',
			2: 'Tệ',
			3: 'Trung bình',
			4: 'Tốt',
			5: 'Xuất sắc'
		};

		stars.forEach(star => {
			star.addEventListener('click', function() {
				const rating = this.getAttribute('data-rating');
				setRating(rating);
			});

			star.addEventListener('mouseenter', function() {
				const rating = this.getAttribute('data-rating');
				highlightStars(rating);
			});
		});

		document.getElementById('starRatingInput')?.addEventListener('mouseleave', function() {
			const currentRating = ratingValue?.value || 0;
			highlightStars(currentRating);
		});

		function setRating(rating) {
			if (ratingValue) ratingValue.value = rating;
			if (ratingLabel) ratingLabel.textContent = ratingLabels[rating] || '';
			highlightStars(rating);
		}

		function highlightStars(rating) {
			stars.forEach(star => {
				const starRating = star.getAttribute('data-rating');
				if (starRating <= rating) {
					star.classList.remove('fa-regular');
					star.classList.add('fa-solid');
				} else {
					star.classList.remove('fa-solid');
					star.classList.add('fa-regular');
				}
			});
		}

		function addToCartAndRedirect(courseId) {
			const isAuthenticated = document.body.dataset.userAuthenticated === 'true';
			if (!isAuthenticated) {
				window.location.href = '/Account/Login?returnUrl=' + encodeURIComponent(window.location.pathname);
				return;
			}

			fetch(`/api/cart/add/${courseId}`, {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' }
			})
			.then(response => response.json())
			.then(data => {
				if (data.success) {
					document.dispatchEvent(new CustomEvent('cartUpdated'));
					if (typeof toastr !== 'undefined') {
						toastr.success('Đã thêm vào giỏ hàng thành công!');
					}
					setTimeout(() => {
						window.location.href = '/checkout';
					}, 1000);
				} else {
					if (typeof toastr !== 'undefined') {
						toastr.error(data.message || 'Không thể thêm vào giỏ hàng');
					}
				}
			})
			.catch(error => {
				console.error('Error adding to cart:', error);
				if (typeof toastr !== 'undefined') {
					toastr.error('Đã xảy ra lỗi');
				}
			});
		}
		function addCourseToCart(courseId) {
			const isAuthenticated = document.body.dataset.userAuthenticated === 'true';
			if (!isAuthenticated) {
				window.location.href = '/Account/Login?returnUrl=' + encodeURIComponent(window.location.pathname);
				return;
			}

			fetch(`/api/cart/add/${courseId}`, {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' }
			})
			.then(response => response.json())
			.then(data => {
				if (data.success) {
					document.dispatchEvent(new CustomEvent('cartUpdated'));
					if (typeof toastr !== 'undefined') {
						toastr.success('Đã thêm vào giỏ hàng thành công!');
					}
				} else {
					if (typeof toastr !== 'undefined') {
						toastr.error(data.message || 'Không thể thêm vào giỏ hàng');
					}
				}
			})
			.catch(error => {
				console.error('Error adding to cart:', error);
				if (typeof toastr !== 'undefined') {
					toastr.error('Đã xảy ra lỗi');
				}
			});
		}
	</script>
}